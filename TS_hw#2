setwd('C:\\Users\\Laney\\Documents\\Data')

library(readxl)
library(zoo)
library(forecast)
library(haven)
library(fma)
library(expsmooth)
library(lmtest)
library(seasonal)

df <- read.csv("Time Corrected Well Data.csv", header = TRUE)

#change to date format
df$monthday <- as.Date(df$UTC.Date , "%m/%d/%Y")

#take substring of month to remove day element
df$month <- substr(df$monthday, 1, 7)

#aggregate hourly data to monthly
df_monthly <- aggregate(df[, 6], list(df$month), mean)

#check for missing values - there are no missing
#values in either of our datasets
table(is.na(df))
table(is.na(df_monthly))

#create test set of last 6 months
df_test <- df_monthly[124:129,]
df_train <- df_monthly[1:123,]

#creation of time series object
wells <- ts(df_train$x, start=c(2007,10), frequency =12)

#time series decomposition
decomp_stl <- stl(wells, s.window = 7)
plot(decomp_stl)

# Actual well water values overlaid with the trend/cycle for the training set.
plot(wells, col = "black", main = "Well Depth - Trend/Cycle", xlab = "", ylab = "Corrected Measurement", lwd = 2)
lines(decomp_stl$time.series[,2], col = "red", lwd = 2)

#take values from well and trend, export to csv so that we
#can make pretty graphs in excel?
write.csv(as.data.frame(wells),"test.csv")
write.csv(as.data.frame(decomp_stl$time.series[,2]),"test1.csv")
wells1 <- read.csv("test.csv", header = TRUE)
trend1 <- read.csv("test1.csv", header = TRUE)
wells1$trend <- trend1$x
names(wells1) <- c("index", "corrected", "trend")
wells1$index <- NULL
write.csv(wells1, 'Well Depth - Trend - Cycle.csv')

new= wells-decomp_stl$time.series[,1]
plot(wells, col = "black", main = "Well Depth - Trend/Cycle", xlab = "", ylab = "Corrected Measurement", lwd = 2)
lines(new,col='red',lwd=2)
 
#we chose STL: someone explain this
#holt-winter b/c we don't really have trend but we do have seasonality, no upward trend so we are doing additive model
model = hw(wells,seasonal = "additive", h = 6)
summary(model)
plot(model)
#AIC 286.67


df_train2 <- df_monthly[64:123,]
wells_interr <- ts(df_train$x, start=c(2013,1), frequency =12)
model2 = hw(wells_interr,seasonal = "additive", h = 6)
summary(model2)
plot(model2)
#AIC 91.92

#model2 = holt(wells,seasonal = 'additive', h = 6)
#summary(model2)
#plot(model2)

#predicted versus actual 

plot(model$mean,df_test$x)

